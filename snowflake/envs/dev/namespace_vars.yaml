IAM:
  role_name: "S3ToStorage_integration"
# TODO:大域変数みたいな使い方したくないが、DRY優先とするならrootにおく？ファイル名namespace_vars_dev.yamlとかにしてやればよさそう
# TODO:完全修飾をこのyaml上でやってるやつとtfでやってるやつがある。混乱を招きそうなので統一したい。
# tfでやるとsnowflake側で実行エラー(terraformで特定できない)になる可能性ある模様。可能ならここで完全修飾必要ならやっとく。
# TODO:内容の分割と配置場所の検討。ごちゃごちゃしてる。
# TODO:これリソース名とか小文字がよかった。SQL内で予約語と区別できない。→修正済み
warehouses:
  - name: "TEST_WAREHOUSE"
    warehouse_size: "XSMALL"
    auto_suspend: 60
    auto_resume: true
    initially_suspended: true
  - name: "TRANSFORMING"
    warehouse_size: "XSMALL"
    auto_suspend: 60
    auto_resume: true
    initially_suspended: true

databases:
  - name: "TEST_DB"
    schemas:
      - "TEST_SCHEMA"
      - "TEST_SCHEMA2"
  - name: "RAW"
    schemas:
      - "JAFFLE_SHOP"
      - "STRIPE"
  - name: "ANALYTICS"
    schemas:
      - "TMP" # スキーマ無し作成ができない。できないけどスキーマ無いdatabase作るか？

tables:
  - name: "TEST_TABLE"
    database: "TEST_DB"
    schema: "TEST_SCHEMA"
    column: 
      - name: "A"
        type: "string"
      - name: "B"
        type: "string"
  - name: "CUSTOMERS"
    database: "RAW"
    schema: "JAFFLE_SHOP"
    column: 
      - name: "id"
        type: "integer"
      - name: "first_name"
        type: "varchar"
      - name: "last_name"
        type: "varchar"
  - name: "ORDERS"
    database: "RAW"
    schema: "JAFFLE_SHOP"
    column: 
      - name: "id"
        type: "integer"
      - name: "user_id"
        type: "integer"
      - name: "order_date"
        type: "date"
      - name: "status"
        type: "varchar"
      - name: "_etl_loaded_at"
        type: "TIMESTAMP_TZ(9)"
        default: "CURRENT_TIMESTAMP()"
  - name: "PAYMENT"
    database: "RAW"
    schema: "STRIPE"
    column: 
      - name: "id"
        type: "integer"
      - name: "orderid"
        type: "integer"
      - name: "PAYMENTmethod"
        type: "varchar"
      - name: "status"
        type: "varchar"
      - name: "amount"
        type: "integer"
      - name: "created"
        type: "date"
      - name: "_batched_at"
        type: "TIMESTAMP_TZ(9)"
        default: "CURRENT_TIMESTAMP()"

# TODO:複数のstorage_integration実装。現在単一のS3を対象にしかできない。
storage_integration:
  name: "TEST_STORAGE_INTEGRATION"
  type: "EXTERNAL_STAGE"
  storage_provider: "S3"
  enabled: true

stage:
  name: "TEST_STAGE"
  database: "TEST_DB"
  schema: "TEST_SCHEMA"
  storage_integration: "TEST_STORAGE_INTEGRATION"
  encryption: "NONE"

file_formats:
  - name: "TEST_FORMAT"
    database: "TEST_DB"
    schema: "TEST_SCHEMA"
    format_type: "CSV"
  - name: "JAFFLE_SHOP_CUSTOMERS_FORMAT"
    database: "RAW"
    schema: "JAFFLE_SHOP"
    format_type: "CSV"
    skip_header: 1
    field_delimiter: ","
  - name: "JAFFLE_SHOP_ORDERS_FORMAT"
    database: "RAW"
    schema: "JAFFLE_SHOP"
    format_type: "CSV"
    skip_header: 1
    field_delimiter: ","
  - name: "STRIPE_PAYMENTS_FORMAT"
    database: "RAW"
    schema: "STRIPE"
    format_type: "CSV"
    skip_header: 1
    field_delimiter: ","

pipes:
  - name: "TEST_PIPE"
    from_database: "TEST_DB"
    from_schema: "TEST_SCHEMA"
    stage_name: "TEST_STAGE"
    to_database: "TEST_DB"
    to_schema: "TEST_SCHEMA"
    target_table: "TEST_TABLE"
    comment: "こっち使うほうがいい？→https://registry.terraform.io/modules/Snowflake-Labs/snowpipe-aws/snowflake/latest#required-parameters"
    auto_ingest: false
    sql_file_name: "copy_statement.sql"
    target_format_name: "TEST_FORMAT"
  - name: "TEST_PIPE2"
    from_database: "TEST_DB"
    from_schema: "TEST_SCHEMA"
    stage_name: "TEST_STAGE"
    to_database: "TEST_DB"
    to_schema: "TEST_SCHEMA"
    target_table: "TEST_TABLE"
    comment: "snowsightでデバッグする用"
    auto_ingest: false
    sql_file_name: "copy_statement.sql"
    target_format_name: "TEST_FORMAT"
  - name: "DBT_JAFFLE_SHOP_CUSTOMERS_PIPE"
    from_database: "TEST_DB"
    from_schema: "TEST_SCHEMA"
    stage_name: "TEST_STAGE"
    stage_sub_dir: JAFFLE_SHOP_CUSTOMERS
    to_database: "RAW"
    to_schema: "JAFFLE_SHOP"
    target_table: "CUSTOMERS"
    comment: "JAFFLE_SHOP_CUSTOMERS"
    auto_ingest: false
    sql_file_name: "copy_statement.sql"
    target_format_name: "JAFFLE_SHOP_CUSTOMERS_FORMAT"
  - name: "DBT_JAFFLE_SHOP_CUSTOMERS_PIPE2"
    from_database: "TEST_DB"
    from_schema: "TEST_SCHEMA"
    stage_name: "TEST_STAGE"
    stage_sub_dir: JAFFLE_SHOP_CUSTOMERS
    to_database: "RAW"
    to_schema: "JAFFLE_SHOP"
    target_table: "CUSTOMERS"
    comment: "snowsightでデバッグする用"
    auto_ingest: false
    sql_file_name: "copy_statement.sql"
    target_format_name: "JAFFLE_SHOP_CUSTOMERS_FORMAT"
  - name: "DBT_JAFFLE_SHOP_ORDERS_PIPE"
    from_database: "TEST_DB"
    from_schema: "TEST_SCHEMA"
    stage_name: "TEST_STAGE"
    stage_sub_dir: JAFFLE_SHOP_ORDERS
    to_database: "RAW"
    to_schema: "JAFFLE_SHOP"
    target_table: "ORDERS"
    comment: "JAFFLE_SHOP_ORDERS"
    auto_ingest: false
    sql_file_name: "copy_statement.sql"
    target_format_name: "JAFFLE_SHOP_ORDERS_FORMAT"
  - name: "DBT_STRIPE_PAYMENTS_PIPE"
    from_database: "TEST_DB"
    from_schema: "TEST_SCHEMA"
    stage_name: "TEST_STAGE"
    stage_sub_dir: "STRIPE_PAYMENTS"
    to_database: "RAW"
    to_schema: "STRIPE"
    target_table: "PAYMENT"
    comment: "STRIPE_PAYMENTS"
    auto_ingest: false
    sql_file_name: "copy_statement.sql"
    target_format_name: "STRIPE_PAYMENTS_FORMAT"

grants_ownership:
  - object_type: "PIPE"
    object_name: "TEST_DB.TEST_SCHEMA.TEST_PIPE"
    account_role_name: "AIRFLOW_ROLE"
    outbound_privileges: "REVOKE"
  - object_type: "PIPE"
    object_name: "RAW.JAFFLE_SHOP.DBT_JAFFLE_SHOP_CUSTOMERS_PIPE"
    account_role_name: "AIRFLOW_ROLE"
  - object_type: "PIPE"
    object_name: "RAW.JAFFLE_SHOP.DBT_JAFFLE_SHOP_ORDERS_PIPE"
    account_role_name: "AIRFLOW_ROLE"
  - object_type: "PIPE"
    object_name: "RAW.STRIPE.DBT_STRIPE_PAYMENTS_PIPE"
    account_role_name: "AIRFLOW_ROLE"

# TODO:ユーザ、ロール系切り離してもいいかも
users:
  - name: "ANALYST1"
  - name: "DEV1"
  - name: "DEV2"

rsa_user:
  - name: "AIRFLOW"
    login_name:  "AIRFLOW"
    rsa_public_key: "/keys/rsa_key_airflow.pub" # rootからの相対パス
    default_role: "AIRFLOW_ROLE"
    default_warehouse: "TEST_WAREHOUSE"
    default_namespace: "TEST_DB.TEST_SCHEMA"
  - name: "DBT_USER"
    login_name: "DBT_USER"
    password: "aaa"
    rsa_public_key: "/keys/rsa_key_dbt.pub"
    default_role: "DBT_ROLE"
    default_warehouse: "TRANSFORMING"
    default_namespace: "RAW.JAFFLE_SHOP"
    
# https://docs.snowflake.com/ja/user-guide/key-pair-auth

# AIRFLOWに必要な権限情報参考：https://docs.snowflake.com/ja/user-guide/data-load-snowpipe-intro#pausing-or-resuming-pipes
# 上記に加えてwarehouseのUSAGE,FILE FORMATSのUSAGEが必要。
account_grants_privileges:
  - account_role_name: "AIRFLOW_ROLE"
    privileges:
    - "USAGE"
    object_type: "WAREHOUSE"
    object_name: "TEST_WAREHOUSE"
  - account_role_name: "AIRFLOW_ROLE"
    privileges:
    - "USAGE"
    object_type: "INTEGRATION"
    object_name: "TEST_STORAGE_INTEGRATION" 
  - account_role_name: "DBT_ROLE"
    privileges:
    - "USAGE"
    object_type: "WAREHOUSE"
    object_name: "TRANSFORMING"

grants_user_to_account:
  - role_name: "AIRFLOW_ROLE"
    user_name: "AIRFLOW"
  - role_name: "DBT_ROLE"
    user_name: "DBT_USER"

# データベースの権限付与
# TODO:適切な名前空間の粒度検討。とりあえずは階層が深くなりすぎないように分割する。

database_grants_on_database:
  - database_role_name: "AIRFLOW_EXECUTE_PIPE"
    on_database: "TEST_DB"
    privileges:
      - USAGE
  - database_role_name: "DBT_DATABASE_ROLE"
    on_database: "RAW"
    privileges:
      - USAGE

database_grants_on_schema:
  - database_role_name: "AIRFLOW_EXECUTE_PIPE"
    on_database: "TEST_DB" # roleもschemaも完全修飾名のため設定。
    on_schema: "TEST_SCHEMA" # TODO:スキーマ単位でリストにした方がいいか?↓を見るにした方がよさそう（優先度低）
    privileges: 
      - USAGE
  - database_role_name: "DBT_DATABASE_ROLE"
    on_database: "RAW"
    on_schema: "JAFFLE_SHOP"
    privileges: 
      - USAGE
      - CREATE VIEW  # dbtで使用 
      - CREATE TABLE # dbtでS使用
  - database_role_name: "DBT_DATABASE_ROLE"
    on_database: "RAW"
    on_schema: "STRIPE"
    privileges: 
      - USAGE
      - CREATE VIEW 
      - CREATE TABLE 

# スキーマオブジェクトの権限付与
# TODO:空のrole作成→権限付与とするべき？対応するリソースないと困る。
# TODO:DBroleこれをもとに作成するのやめるべきか？
database_grants_in_schema:
  - database_role_name: "DB_READ_ROLE"
    database_name: "TEST_DB"
    in_schema: "TEST_SCHEMA"
    object_privileges: 
      TABLES:
        - SELECT
  - database_role_name: "AIRFLOW_EXECUTE_PIPE"
    database_name: "TEST_DB"
    in_schema: "TEST_SCHEMA"
    object_privileges: 
      TABLES:
        - SELECT
        - INSERT
      STAGES:
        - USAGE # 外部ステージ(S3)のため。内部ならRead
      FILE FORMATS:
        - USAGE  
      PIPES:
        - OPERATE
  - database_role_name: "DBT_DATABASE_ROLE"
    database_name: "RAW"
    in_schema: "JAFFLE_SHOP"
    object_privileges: 
      TABLES:
        - SELECT
        - INSERT
      STAGES:
        - USAGE
      FILE FORMATS:
        - USAGE  
      PIPES:
        - OPERATE
  - database_role_name: "DBT_DATABASE_ROLE"
    database_name: "RAW"
    in_schema: "STRIPE"
    object_privileges: 
      TABLES:
        - SELECT
        - INSERT
      STAGES:
        - USAGE
      FILE FORMATS:
        - USAGE  
      PIPES:
        - OPERATE

account_roles:
  - name: "ANALYST_ROLE"
    comment: "test comment"
    grants_database_roles:
      - database: "TEST_DB"
        names:
        - "DB_READ_ROLE"
  - name: "AIRFLOW_ROLE"
    comment: "Airflow only"
    grants_database_roles:
      - database: "TEST_DB"
        names:
        - "AIRFLOW_EXECUTE_PIPE"
      - database: "RAW"
        names:
        - "DBT_DATABASE_ROLE"
  - name: "DBT_ROLE"
    comment: "DBT用. 権限付与はsnowsight上で行う。https://docs.snowflake.com/ja/user-guide/data-engineering/dbt-projects-on-snowflake-access-control の権限付与できるリソースが現状なさそう。→dbt Coreに関しては別にこれいらなさそう。CREATE VIEW権限でSELECTは普通にできた。"
    grants_database_roles:
      - database: "RAW"
        names:
        - "DBT_DATABASE_ROLE"